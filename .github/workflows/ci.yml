name: CI/CD Freelance Finance API

# 1. DISPARADORES: Cuándo se activa el Pipeline
on:
  push:
    branches: ["main"]
    tags: ["v*"] # Se activa también cuando creas una versión v1.0, v1.1, etc.

jobs:
  # 2. FASE DE CALIDAD: Build y Test
  build-and-test:
    runs-on: self-hosted
    steps:
      - name: Descargar código del repo
        uses: actions/checkout@v3

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest httpx

      - name: Ejecutar pruebas automáticas (Pytest)
        run: pytest

      - name: Construir Imagen de Docker
        run: |
          # Usamos el SHA del commit para que cada imagen sea única e inmutable
          docker build -t finance-api:${{ github.sha }} .
          docker tag finance-api:${{ github.sha }} finance-api:latest

  # 3. FASE DE RELEASE: Staging (Puerto 8080)
  deploy-staging:
    needs: build-and-test
    runs-on: self-hosted
    # Solo se ejecuta si es un push normal a la rama main (no un tag)
    if: github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Desplegar en Staging (8080)
        run: |
          docker stop finance-staging || true
          docker rm finance-staging || true
          docker run -d \
            --name finance-staging \
            -p 8080:8000 \
            -e DATABASE_URL="${{ secrets.STAGING_DB }}" \
            -e ENVIRONMENT="STAGING" \
            finance-api:latest

  # 4. FASE DE RELEASE: Producción (Puerto 80)
  deploy-production:
    needs: build-and-test
    runs-on: self-hosted
    # Solo se ejecuta si creaste un tag de versión (ej: v1.0)
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Desplegar en Producción (80)
        run: |
          docker stop finance-prod || true
          docker rm finance-prod || true
          docker run -d \
            --name finance-prod \
            -p 80:8000 \
            -e DATABASE_URL="${{ secrets.PROD_DB }}" \
            -e ENVIRONMENT="PRODUCTION" \
            finance-api:latest
