name: CI/CD Freelance Finance API

# FASE 1: SOURCE (Origen)
# El pipeline se activa cada vez que subes código a la rama 'main'
on:
  push:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    # FASE 2: BUILD (Construcción del entorno)
    - name: Descargar código del repo
      uses: actions/checkout@v3

    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest  # Necesario para la fase de Test

    # FASE 3: TEST (Pruebas de Calidad)
    - name: Ejecutar pruebas automáticas
      run: |
        # Aquí correrías tus tests. Si uno falla, el pipeline se detiene.
        pytest

    # FASE 4: BUILD DOCKER (Creación del Artefacto Inmutable)
    - name: Construir Imagen de Docker
      run: |
        docker build -t finance-api:${{ github.sha }} .
        # Usamos el ID del commit (sha) como versión única (Factor V)

    # FASE 5: DEPLOY (Despliegue a tu Ubuntu Server)
    - name: Desplegar en Servidor Ubuntu
      # Aquí es donde el Pipeline se conecta a tu servidor real
      # Nota: Necesitas configurar 'Secrets' en GitHub para esto
      run: |
        echo "Conectando al servidor ${{ secrets.SERVER_IP }}..."
        # (Aquí irían los comandos SSH para actualizar tu App)
